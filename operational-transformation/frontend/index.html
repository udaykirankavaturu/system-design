<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Concurrent OT Client</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        padding: 20px;
      }
      .user-col {
        border-left: 1px solid #ddd;
        padding-left: 15px;
      }
      #simulationLog {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        height: 300px;
        overflow-y: scroll;
        padding: 10px;
        font-family: monospace;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <h1 class="mb-4">Concurrent Operational Transformation</h1>
      <div id="feedbackMessage" class="alert" style="display: none"></div>

      <div class="row">
        <!-- Server Column -->
        <div class="col-md-3">
          <h3>Server State</h3>
          <p>Revision: <strong id="serverRevision">0</strong></p>
          <button class="btn btn-info mb-3" onclick="getDocument()">
            Get Server Document
          </button>
          <button class="btn btn-danger mb-3" onclick="resetDocument()">
            Reset Document
          </button>
          <pre id="serverState">Hello, world!</pre>
        </div>

        <!-- User Columns -->
        <div class="col-md-9">
          <div class="row">
            <div class="col-md-4 user-col" id="user1">
              <h4>User 1</h4>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="" id="user1-check" checked>
                <label class="form-check-label" for="user1-check">
                  Send to Server
                </label>
              </div>
              <div class="input-group mb-2">
                <select class="form-select">
                  <option value="insert">Insert</option>
                  <option value="delete">Delete</option>
                </select>
                <input type="number" class="form-control" placeholder="Pos" value="7" />
                <input type="text" class="form-control" placeholder="Text" value="beautiful " />
              </div>
            </div>
            <div class="col-md-4 user-col" id="user2">
              <h4>User 2</h4>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="" id="user2-check" checked>
                <label class="form-check-label" for="user2-check">
                  Send to Server
                </label>
              </div>
              <div class="input-group mb-2">
                <select class="form-select">
                  <option value="insert">Insert</option>
                  <option value="delete">Delete</option>
                </select>
                <input type="number" class="form-control" placeholder="Pos" value="7" />
                <input type="text" class="form-control" placeholder="amazing " />
              </div>
            </div>
            <div class="col-md-4 user-col" id="user3">
              <h4>User 3</h4>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="" id="user3-check" checked>
                <label class="form-check-label" for="user3-check">
                  Send to Server
                </label>
              </div>
              <div class="input-group mb-2">
                <select class="form-select">
                  <option value="insert">Insert</option>
                  <option value="delete">Delete</option>
                </select>
                <input type="number" class="form-control" placeholder="Pos" value="7" />
                <input type="text" class="form-control" placeholder="wonderful " />
              </div>
            </div>
          </div>
          <button class="btn btn-primary mt-3" onclick="simulateConcurrentEdits()">
            Simulate Concurrent Edits
          </button>
        </div>
      </div>

      <div class="row mt-4">
          <div class="col-md-12">
              <h4>Simulation Log</h4>
              <div id="simulationLog"></div>
          </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = "http://127.0.0.1:8000";
      let serverRevision = 0;

      const logContainer = document.getElementById("simulationLog");

      function log(message) {
        logContainer.innerHTML += message + '\n';
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      function clearLog() {
        logContainer.innerHTML = '';
      }

      async function getDocument() {
        const response = await fetch(`${API_BASE_URL}/document`);
        const data = await response.json();
        document.getElementById("serverState").textContent = data.doc;
        document.getElementById("serverRevision").textContent = data.revision;
        serverRevision = data.revision;
        return data;
      }

      async function simulateConcurrentEdits() {
        clearLog();

        log("--- Starting Simulation ---");
        // First, ensure we know the server's starting state.
        const startState = await getDocument();
        const initialRevision = startState.revision;
        log(`All clients start with document at revision ${initialRevision}: "${startState.doc}"`);
        log("-------------------------------------");

        const users = ["user1", "user2", "user3"];
        const operations = [];
        users.forEach((userId) => {
            const userCol = document.getElementById(userId);
            const checkbox = userCol.querySelector('input[type=checkbox]');
            if (checkbox.checked) {
                const op_type = userCol.querySelector("select").value;
                const pos = parseInt(userCol.querySelector("input[type=number]").value);
                const text = userCol.querySelector("input[type=text]").value;
                operations.push({ userId, op: { op_type, pos, text } });
            }
        });

        if (operations.length === 0) {
            showFeedback("No operations selected to send.", "info");
            log("--- Simulation Ended: No operations selected. ---");
            return;
        }

        // Send operations one by one, all based on the same initial revision
        for (const {userId, op} of operations) {
            await sendOperation(userId, op, initialRevision);
        }

        log("-------------------------------------");
        log("--- Simulation Finished ---");
        const finalState = await getDocument();
        log(`Final server document at revision ${finalState.revision}: "${finalState.doc}"`);
        showFeedback("Simulation finished. Check the log for details.", "success");
      }

      async function sendOperation(userId, op, revision) {
        log(`[SEND] ${userId} sending op: ${JSON.stringify(op)} based on revision ${revision}`);
        try {
            const response = await fetch(`${API_BASE_URL}/apply-operation`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ op, revision }),
            });

            const result = await response.json();

            if (!response.ok) {
                log(`[FAIL] ${userId} request failed: ${result.detail}`);
            } else {
                log(`[RECV] ${userId} op accepted. Server is now at revision ${result.revision}.`);
                log(`       Original op: ${JSON.stringify(op)}`);
                log(`       Applied op:  ${JSON.stringify(result.applied_op)}`);
                document.getElementById("serverRevision").textContent = result.revision;
                document.getElementById("serverState").textContent = result.doc;
            }
        } catch (error) {
            log(`[ERROR] ${userId} request failed: ${error}`);
        }
        log("...");
      }

      function showFeedback(message, type) {
        const feedbackDiv = document.getElementById("feedbackMessage");
        feedbackDiv.textContent = message;
        feedbackDiv.className = `alert alert-${type}`;
        feedbackDiv.style.display = "block";
        setTimeout(() => {
          feedbackDiv.style.display = "none";
        }, 4000);
      }

      window.onload = getDocument;

      async function resetDocument() {
        try {
            await fetch(`${API_BASE_URL}/reset`, { method: "POST" });
            clearLog();
            log("Document and revision history reset on the server.");
            await getDocument();
            showFeedback("Document reset successfully.", "success");
        } catch (error) {
            console.error("Error resetting document:", error);
            showFeedback("Error resetting document.", "danger");
        }
      }
    </script>
  </body>
</html>