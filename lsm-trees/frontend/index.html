<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSM Tree Visualization</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .node {
            stroke: black;
            stroke-width: 1;
        }
        .node-text {
            font-size: 12px;
            text-anchor: middle;
            dominant-baseline: middle;
        }
        .tombstone {
            fill: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">LSM Tree Visualization</h1>
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Controls</h5>
                        <div class="mb-3">
                            <label for="key-input" class="form-label">Key</label>
                            <input type="text" class="form-control" id="key-input" placeholder="Enter key">
                        </div>
                        <div class="mb-3">
                            <label for="value-input" class="form-label">Value</label>
                            <input type="text" class="form-control" id="value-input" placeholder="Enter value">
                        </div>
                        <button id="set-btn" class="btn btn-primary">Set</button>
                        <hr>
                        <div class="mb-3">
                            <label for="get-key-input" class="form-label">Key to Get</label>
                            <input type="text" class="form-control" id="get-key-input" placeholder="Enter key">
                        </div>
                        <button id="get-btn" class="btn btn-info">Get</button>
                        <p id="get-result" class="mt-2"></p>
                        <hr>
                        <div class="mb-3">
                            <label for="delete-key-input" class="form-label">Key to Delete</label>
                            <input type="text" class="form-control" id="delete-key-input" placeholder="Enter key">
                        </div>
                        <button id="delete-btn" class="btn btn-danger">Delete</button>
                        <hr>
                        <button id="clear-btn" class="btn btn-warning">Clear Tree</button>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Visualization</h5>
                        <h6>MemTable</h6>
                        <svg id="memtable-vis" width="100%" height="100"></svg>
                        <hr>
                        <h6>SSTables</h6>
                        <svg id="sstables-vis" width="100%" height="400"></svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const setBtn = document.getElementById('set-btn');
        const getBtn = document.getElementById('get-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const clearBtn = document.getElementById('clear-btn');
        const keyInput = document.getElementById('key-input');
        const valueInput = document.getElementById('value-input');
        const getKeyInput = document.getElementById('get-key-input');
        const deleteKeyInput = document.getElementById('delete-key-input');
        const getResult = document.getElementById('get-result');
        const memtableVis = d3.select('#memtable-vis');
        const sstablesVis = d3.select('#sstables-vis');

        const API_URL = 'http://127.0.0.1:8000';
        const TOMBSTONE = "__TOMBSTONE__";

        async function fetchData() {
            const response = await fetch(`${API_URL}/data`);
            const data = await response.json();
            updateVisualization(data);
        }

        function updateVisualization(data) {
            const nodeWidth = 80;
            const nodeHeight = 40;

            // MemTable Visualization
            memtableVis.selectAll('*').remove();
            const memtableData = Object.entries(data.memtable);
            const memtableNodes = memtableVis.selectAll('g')
                .data(memtableData)
                .enter()
                .append('g')
                .attr('transform', (d, i) => `translate(${(i * (nodeWidth + 10)) + (nodeWidth/2)}, 50)`);

            memtableNodes.append('rect')
                .attr('width', nodeWidth)
                .attr('height', nodeHeight)
                .attr('fill', d => d[1] === TOMBSTONE ? '#dc3545' : '#f0f0f0')
                .attr('class', 'node');

            memtableNodes.append('text')
                .attr('class', 'node-text')
                .attr('y', nodeHeight / 2)
                .text(d => `${d[0]}: ${d[1] === TOMBSTONE ? 'DEL' : d[1]}`);

            // SSTables Visualization
            sstablesVis.selectAll('*').remove();
            const sstablesData = data.sstables;
            let yOffset = 50;
            sstablesData.forEach((sstable, sstableIndex) => {
                const sstableGroup = sstablesVis.append('g')
                    .attr('transform', `translate(0, ${yOffset})`);

                sstableGroup.append('text')
                    .attr('x', 20)
                    .attr('y', -10)
                    .text(`SSTable ${sstableIndex + 1}`);

                const sstableNodes = sstableGroup.selectAll('g')
                    .data(sstable)
                    .enter()
                    .append('g')
                    .attr('transform', (d, i) => `translate(${(i * (nodeWidth + 10)) + (nodeWidth/2)}, 0)`);

                sstableNodes.append('rect')
                    .attr('width', nodeWidth)
                    .attr('height', nodeHeight)
                    .attr('fill', d => d.value === TOMBSTONE ? '#dc3545' : '#e0e0e0')
                    .attr('class', 'node');

                sstableNodes.append('text')
                    .attr('class', 'node-text')
                    .attr('y', nodeHeight / 2)
                    .text(d => `${d.key}: ${d.value === TOMBSTONE ? 'DEL' : d.value}`);
                
                yOffset += (nodeHeight + 40);
            });
        }

        setBtn.addEventListener('click', async () => {
            await fetch(`${API_URL}/set`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: keyInput.value, value: valueInput.value })
            });
            keyInput.value = '';
            valueInput.value = '';
            fetchData();
        });

        getBtn.addEventListener('click', async () => {
            const response = await fetch(`${API_URL}/get?key=${getKeyInput.value}`);
            const data = await response.json();
            getResult.textContent = `Value: ${data.value}`;
        });

        deleteBtn.addEventListener('click', async () => {
            await fetch(`${API_URL}/delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: deleteKeyInput.value })
            });
            deleteKeyInput.value = '';
            fetchData();
        });

        clearBtn.addEventListener('click', async () => {
            await fetch(`${API_URL}/clear`, { method: 'POST' });
            fetchData();
        });

        fetchData();
    </script>
</body>
</html>
